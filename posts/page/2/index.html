<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Posts &#183; Hrvoje's Blog</title><meta name=description content="It's only ones and zeros"><meta name=generator content="Hugo 0.74.3"><meta name=twitter:card content="summary"><meta name=twitter:title content="Posts &#183; Hrvoje's Blog"><meta name=twitter:description content="It's only ones and zeros"><meta property="og:type" content="article"><meta property="og:title" content="Posts &#183; Hrvoje's Blog"><meta property="og:description" content="It's only ones and zeros"><link rel=stylesheet href=https://blog.hrvoje.org/css/pure-min.css><link rel=stylesheet href=https://blog.hrvoje.org/css/grids-responsive-min.css><link rel=stylesheet href=https://blog.hrvoje.org/css/all.min.css><link rel=stylesheet href=https://blog.hrvoje.org/css/syntax.css><link rel=alternate type=application/rss+xml title="Hrvoje's Blog" href=https://blog.hrvoje.org/index.xml></head><body><div id=layout class=pure-g><div class="content pure-u-1 pure-u-md-1-4"></div><div class="sidebar pure-u-1 pure-u-md-1-2"><div class=header><h1 class=brand-title><a href=https://blog.hrvoje.org/>Hrvoje's blog</a></h1><h2 class=brand-tagline>10 PRINT CHR$(205.5+RND(1)); : GOTO 10</h2></div></div><div class="content pure-u-1 pure-u-md-1-4"></div><div class="content pure-u-1 pure-u-md-3-4"><div><div class=posts><h1 class=content-subhead>17 Jan 2015, 15:53</h1><section class=post><header class=post-header><a href=https://blog.hrvoje.org/2015/01/cookie-math/ class=post-title>Cookie Math</a><p class=post-meta>under</p></header><div class=post-description><p>There was a very interesting presentation at the last 31C3 conference given by
two very talented security researchers: Shahar Tal and Lior Oppenheim. The
vulnerability they found targets many different routers from various
manufacturers and was, apparently, patched 10 years ago (!) by the software
company who made RomPager, the software in question. Let&rsquo;s just say vendors are
slow in deploying patches, leaving tens of millions of routers vulnerable to
potential remote bricking, turning into botnets or who knows what else. It was
named Misfortune Cookie for a good reason, but what does that have to do with
math?</p><p>Apparently, there is a preallocated array in the webserver capable of
storing 10 cookies, 40 bytes each. The cookie number is used as array index -
converted to integer, multiplied by 40 and added to a memory address to read or
write the correct location without ever checking boundaries.</p><p>You can pass an arbitrary number and address any memory location relative to a
certain fixed point in memory. The only catch is that it gets multiplied by 40.
What can you do if you need better precision to avoid overwriting something
else near the memory location you are targeting?</p><p>This can be written in a form of <em>ax ≡ y (mod m)</em> and it&rsquo;s called a <strong>Linear
Congruence</strong>. Obviously, <em>a</em> is 40 since we move in steps of 40. We need to find
such <em>x</em> that multiplied by 40 gives us a desired <em>y</em> modulo <em>m</em> we need to move in
memory relative to the present location. <em>M</em> is
<img src=/img/6de36bf7be6aa5ef824c78d2a53af445.svg alt> (the size of a 32 bit
number could fit 0-4294967295, anything more than that and it will
overflow and start from zero again, just like a clock face starts from
1 when it reaches 12), making the equation 40 <em>x</em> ≡ <em>y</em> (mod
<img src=/img/6de36bf7be6aa5ef824c78d2a53af445.svg alt>).</p><p>For this to have a solution, <em>x</em> needs to be divisible with the greatest common
divisor of both 40 and <img src=/img/6de36bf7be6aa5ef824c78d2a53af445.svg alt>,
which is 8 - that&rsquo;s how many unique solutions we&rsquo;ll get. Now we can
say</p><img class=centerimg src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0Ni45MTIiIGhlaWdodD0iMjAuOTYiIHZpZXdCb3g9IjAgLTc5Ny41IDI1OTIuMSAxMTU4LjEiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIj48ZGVmcz48cGF0aCBpZD0iTUpYLTU5LVRFWC1JLTdBIiBkPSJNMzQ3IDMzOHEtMTAgMC01MyAxMXQtNjMgMTEtMzQtNC0yMy0xMC0xMi0xMS03LTExbC0yLTRxLTMtMy0xNS0zbC0yMSA4cTAgNSAzIDE0IDEzIDM5IDQzIDY3dDY2IDM0cTEyIDIgMTcgMiAyNSAwIDQ1LTE3dDM4LTMzIDM4LTE3cTIyIDAgNDQgMzN0MjMgMzNxMSAxIDE1IDFoMTNxNi02IDYtOCAwLTQtNS0xNHQtMTQtMjEtMTctMjItMTQtMTlsLTctOXEtNDMtNTEtMTM2LTEzNVQxNjAgMTA2TDE0OCA5NGwxNS0xcTIyIDAgNjQtMTF0NjMtMTFxMzggMCA3MCAxOXQ0MiA1MHE0IDkgNyAxMXQxNSAybDE5LTEwcTAtNS0xLTktMTctNjItNjYtMTAzVDI3OC0xMXEtMjYgMC00NiAxN1QxOTMgNDAgMTU1IDU3UTExMSA1NyA3Ni0zcS02LTgtMTctOEg1NCA0MXEtNiA2LTYgOSAwIDE1IDU4IDg2IDM5IDQ1IDEzMiAxMzBUMzQwIDMyMnExMiAxNiA3IDE2eiIvPjxwYXRoIGlkPSJNSlgtNTktVEVYLU4tM0QiIGQ9Ik01NiAzNDdxMCAxMyAxNCAyMEg3MDdxMTUtOCAxNS0yMCAwLTExLTE0LTE5bC0zMTgtMUg3MnEtMTYgNS0xNiAyMHptMC0xOTRxMCAxNSAxNiAyMEg3MDhxMTQtMTAgMTQtMjAgMC0xMy0xNS0yMEg3MHEtMTQgNy0xNCAyMHoiLz48cGF0aCBpZD0iTUpYLTU5LVRFWC1JLTc5IiBkPSJNMjEgMjg3cTAgMTQgMTUgNDh0NDggNzEgNzQgMzZxNDEgMCA2Ni0yM3QyNi02NHEtMi0xOS0zLTIxIDAtMy0xNi00NnQtMzMtOTctMTYtODZxMC00MyAxNC02MHQ0Mi0xOHEyMyAwIDQzIDExdDMxIDIzIDI3IDMzcTAgMSA1IDIwdDE0IDU5IDE5IDc0cTM4IDE1MCA0MiAxNTcgMTMgMjcgNDMgMjcgMTMgMCAyMS03dDExLTEyIDItOXEwLTEzLTQ5LTIxMFQzOTEtMjNxLTI4LTgzLTk3LTEzMlQxNTYtMjA1cS00NSAwLTc5IDIyVDQzLTExN3EwIDIyIDcgMzdUNjktNTggODktNDh0MTcgM2w0NC00MnEwLTIwLTEyLTM1dC0yMy0yMC0xMy01bC0zLTFxMi01IDE5LTEydDM0LTdoOHExNyAwIDI2IDIgMzMgOSA2MSAzOHQ0MyA2MlQzMTMtOXQ4IDMwbC02LTRxLTYtNC0xOS0xMVQyNzAtNnEtMjAtNS0zOS01LTQ2IDAtODEgMjJUMTA0IDgycS0xIDctMSAzMSAwIDU3IDM1IDE0OXQzNSAxMTdxMCAxIDAgMiAwIDkgMCAxMnQtNCA3LTExIDRoLTRxLTIzIDAtNDItMTlUODIgMzQ0IDY1IDMwMnQtOC0yMi0xNi0ySDI3cS02IDYtNiA5eiIvPjxwYXRoIGlkPSJNSlgtNTktVEVYLU4tMzgiIGQ9Ik03MCA0MTd0MCA3NyA1NCAxMjQgMTI0IDQ4cTcxIDAgMTI2LTQydDU1LTEwOXEwLTMwLTExLTU2dC0yNi00Mi0zMS0yOC0yNi0xOC0xMS04bDE0LTlxMTQtMTAgMjgtMjB0MTYtMTFxNzUtNTkgNzUtMTQ5IDAtNzktNTgtMTM3VDI0OS0yMnEtOTAgMC0xNDggNTFUNDMgMTU1cTAgMTA4IDEyOSAxODBsLTE4IDEzcS0yMSAxMy0yNyAyMC01NyA0OS01NyAxMjZ6bTIxNi0zMSA2IDRxNiA0IDkgNnQxMCA3IDEyIDEwIDExIDEyIDExIDEzIDEwIDE2IDkgMTcgNSAyMCAyIDIycTAgNDMtMjkgNzN0LTY3IDM4cS03IDEtMzMgMS00MSAwLTc3LTI2dC0zNy02NXEwLTIzIDEzLTQydDI2LTI5IDUwLTMycTctNSAxMS03bDU4LTM4ek0yNTAgMjFxNTggMCAxZTIgMzR0NDIgODJxMCAxNy01IDMydC0xMiAyNS0yMiAyMi0yMyAxOC0yOSAxOS0yNyAxN3EtMTQgOS0zMCAxOXQtMjYgMTdsLTggNXEtNiAwLTI5LTE3dC00OC01NS0yNi04MnEwLTU5IDQzLTk3VDI1MCAyMXoiLz48L2RlZnM+PGcgc3Ryb2tlPSJjdXJyZW50Y29sb3IiIGZpbGw9ImN1cnJlbnRjb2xvciIgc3Ryb2tlLXdpZHRoPSIwIiB0cmFuc2Zvcm09Im1hdHJpeCgxIDAgMCAtMSAwIDApIj48ZyBkYXRhLW1tbC1ub2RlPSJtYXRoIj48ZyBkYXRhLW1tbC1ub2RlPSJtaSI+PHVzZSB4bGluazpocmVmPSIjTUpYLTU5LVRFWC1JLTdBIi8+PC9nPjxnIGRhdGEtbW1sLW5vZGU9Im1vIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSg3NDIuOCwgMCkiPjx1c2UgeGxpbms6aHJlZj0iI01KWC01OS1URVgtTi0zRCIvPjwvZz48ZyBkYXRhLW1tbC1ub2RlPSJtZnJhYyIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTc5OC42LCAwKSI+PGcgZGF0YS1tbWwtbm9kZT0ibWkiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDIyMy41LCA0ODUpIHNjYWxlKDAuNzA3KSI+PHVzZSB4bGluazpocmVmPSIjTUpYLTU5LVRFWC1JLTc5Ii8+PC9nPjxnIGRhdGEtbW1sLW5vZGU9Im1uIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyMjAsIC0zNDUpIHNjYWxlKDAuNzA3KSI+PHVzZSB4bGluazpocmVmPSIjTUpYLTU5LVRFWC1OLTM4Ii8+PC9nPjxyZWN0IHdpZHRoPSI1NTMuNiIgaGVpZ2h0PSI2MCIgeD0iMTIwIiB5PSIyMjAiLz48L2c+PC9nPjwvZz48L3N2Zz4="><p>and reduce the expression to <em>5x ≡ z (mod 536870912)</em>. The way
to solve it is to find the multiplicative inverse modulo <em>m</em> - a
number we can multiply both sides with so that it gives 1 when
multiplied by 5 in this modular algebra.</p><img class=centerimg src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyODguNzY4IiBoZWlnaHQ9IjIwLjUyIiB2aWV3Qm94PSIwIC04ODMuOSAxNTk1NC4yIDExMzMuOSIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiPjxkZWZzPjxwYXRoIGlkPSJNSlgtMTAtVEVYLU4tMzUiIGQ9Ik0xNjQgMTU3cTAtMjQtMTYtNDB0LTM5LTE2aC03cTQ2LTc5IDEyMi03OSA3MCAwIDEwMiA2MCAxOSAzMyAxOSAxMjggMCAxMDMtMjcgMTM5LTI2IDMzLTU4IDMzaC02cS03OCAwLTExOC02OC00LTctNy04dC0xNS0ycS0xNyAwLTE5IDYtMiA0LTIgMTc1VjYxNGw1IDUwcTIgMiA0IDIgMSAwIDIxLTh0NTUtMTYgNzUtOHE3MSAwIDEzNiAyOCA4IDQgMTMgNGw4LTE4VjYzNXEtODItOTctMjA1LTk3LTMxIDAtNTYgNmwtMTAgMlYzNzRxMTkgMTQgMzAgMjJ0MzYgMTYgNTEgOHE4MSAwIDEzNy02NXQ1Ni0xNTRxMC05Mi02NC0xNTdUMjI5LTIyUTE0OC0yMiA5OSAzMlQ1MCAxNTRxMCAyNCAxMSAzOHQyMyAxOCAyMyA0cTI1IDAgNDEtMTd0MTYtNDB6Ii8+PHBhdGggaWQ9Ik1KWC0xMC1URVgtTi0yMjEyIiBkPSJNODQgMjM3dDAgMTMgMTQgMjBINjc5cTE1LTggMTUtMjB0LTE1LTIwSDk4cS0xNCA3LTE0IDIweiIvPjxwYXRoIGlkPSJNSlgtMTAtVEVYLU4tMzEiIGQ9Ik0yMTMgNTc4bC0xMy01cS0xNC01LTQwLTEwdC01OC03SDgzdjQ2aDE5cTQ3IDIgODcgMTV0NTYgMjQgMjggMjJxMiAzIDEyIDMgOSAwIDE3LTZWMzYxbDEtM2UycTctNyAxMi05dDI0LTQgNjItMmgyNlYwSDQxNlEzOTUgMyAyNTcgMyAxMjEgMyAxZTIuMEg4OFY0NmgyNnEyMiAwIDM4IDB0MjUgMSAxNiAzIDggMiA2IDUgNiA0VjU3OHoiLz48cGF0aCBpZD0iTUpYLTEwLVRFWC1OLTI4IiBkPSJNOTQgMjUwcTAgNjkgMTAgMTMxdDIzIDEwNyAzNyA4OCAzOCA2NyA0MiA1MiAzMyAzNCAyNSAyMWgxMyA0bDE0LTlxMC0zLTE3LTIxdC00MS01My00OS04Ni00Mi0xMzgtMTctMTkzVDE4NCA1OCAyMjUtODF0NDktODYgNDItNTMgMTctMjFsLTE1LTloLTMtMTNsLTI4IDI0UTE4MC0xNDEgMTM3LTE0VDk0IDI1MHoiLz48cGF0aCBpZD0iTUpYLTEwLVRFWC1OLTZEIiBkPSJNNDEgNDZINTVxMzkgMCA0NyAxNHY4cTAgOSAwIDIzdDAgMzEgMSAzOSAwIDQycTAgMzEgMCA2NnQtMSA1OXYyM3EtMyAxOS0xNCAyNXQtNDUgOUgyNXYyM2wyIDIzIDEwIDFxMTAgMSAyOCAydDM3IDJxMTcgMSAzNiAydDI5IDMgMTEgMWgzVjQwMmwxLTM4dDUgNSAxMiAxNSAxOSAxOCAyOSAxOSAzOCAxNnEyMCA1IDUxIDUgMTUgMCAyOC0ydDIzLTYgMTktOCAxNS05IDExLTExIDktMTEgNy0xMSA0LTEwIDMtOGwyLTUgMyA0cTMgNCA2IDh0OSAxMSAxMyAxMyAxNSAxMyAyMCAxMiAyMyAxMCAyNiA3IDMxIDNxMTI2IDAgMTM3LTExMyAxLTcgMS0xMzlWMTA0cTAtMzggMi00NXQxMS0xMHEyMS0zIDQ5LTNoMTZWMGgtOEw3ODggMXEtMjQgMS01MSAxVDY5OSAzUTU5NiAzIDU4NyAwaC04VjQ2aDE2bDYxIDE2cTEgMiAxIDEzOC0xIDEzNS0yIDE0My02IDI4LTIwIDQydC0yNCAxNy0yNiAycS00NSAwLTc5LTM0LTI3LTI3LTM0LTU1dC04LTgzVjE2OCAxMDhxMC0zMCAxLTQwdDMtMTMgOS02cTIxLTMgNDktM2gxNlYwaC04TDUxMCAxcS0yMyAxLTUwIDFUNDIyIDNRMzE5IDMgMzEwIDBoLThWNDZoMTZsNjEgMTZxMSAyIDEgMTM4LTEgMTM1LTIgMTQzLTYgMjgtMjAgNDJ0LTI0IDE3LTI2IDJxLTQ1IDAtNzktMzQtMjctMjctMzQtNTV0LTgtODNWMTY4IDEwOHEwLTMwIDEtNDB0My0xMyA5LTZxMjEtMyA0OS0zaDE2VjBoLThMMjM0IDFxLTI0IDEtNTEgMVQxNDUgM1E0MiAzIDMzIDBIMjVWNDZINDF6Ii8+PHBhdGggaWQ9Ik1KWC0xMC1URVgtTi02RiIgZD0iTTI4IDIxNHEwIDk1IDY1IDE2NHQxNTcgNzBxOTAgMCAxNTUtNjh0NjYtMTY1cTAtOTUtNjQtMTYwVDI1MC0xMFExNTMtMTAgOTEgNTdUMjggMjE0ek0yNTAgMzAgMzcyIDE5M3YzMiAyNXEwIDIyLTEgMzh0LTcgMzgtMTYgMzYtMzEgMjgtNDkgMjBxLTUgMS0xNiAxLTMwIDAtNTctMTItNDMtMjItNTYtNjF0LTEzLTkyVjIyNnEwLTk2IDE5LTEzNSAzMi02MSAxMDUtNjF6Ii8+PHBhdGggaWQ9Ik1KWC0xMC1URVgtTi02NCIgZD0iTTM3NiA0OTVxMCAxNiAwIDQwdDEgMzNxMCA0NS0xMCA1NnQtNTEgMTNIMjk4djIzbDIgMjMgMTAgMXExMCAxIDI5IDJ0MzcgMnExNyAxIDM3IDJ0MzAgMyAxMSAxaDNWMzkwcTAtMzA2IDEtMzA5IDMtMjAgMTQtMjZ0NDUtOWgxOFYwcS0yIDAtNzYtNXQtNzktNmgtN1Y0NGwtOC03UTMwNy0xMSAyMzUtMTEgMTU4LTExIDk2IDUwVDM0IDIxNXEwIDFlMiA2MyAxNjN0MTQ3IDY0cTc1IDAgMTMyLTQ5VjQ5NXptLTMtMTUzcS00NSA2My0xMTMgNjMtNDkgMC04Ny0zNi0yNy0yOC0zNC02NHQtOC05NHEwLTU2IDctOTF0MzUtNjFxMzAtMzMgNzgtMzMgNzEgMCAxMjIgNzdWMzQyeiIvPjxwYXRoIGlkPSJNSlgtMTAtVEVYLU4tMzMiIGQ9Ik0xMjcgNDYzcS0yNyAwLTQyIDE3VDY5IDUyNHEwIDU1IDQ4IDk4dDExNiA0M3EzNSAwIDQ0LTEgNzQtMTIgMTEzLTUzdDQwLTg5cTAtNTItMzQtMTAxdC05NC03MWwtMy0ycTAtMSA5LTN0MjktOSAzOC0yMXE4Mi01MyA4Mi0xNDAgMC03OS02Mi0xMzhUMjM4LTIycS04MCAwLTEzOCA0M1Q0MiAxMzBxMCAyOCAxOCA0NXQ0NSAxOHEyOCAwIDQ2LTE4dDE4LTQ1cTAtMTEtMy0yMHQtNy0xNi0xMS0xMi0xMi04LTEwLTQtOC0zbC00LTFxNTEtNDUgMTI0LTQ1IDU1IDAgODMgNTMgMTcgMzMgMTcgMTAxdjIwcTAgOTUtNjQgMTI3LTE1IDYtNjEgN2wtNDIgMS0zIDJxLTIgMy0yIDE2bDggMThxMjggMCA1OCA1IDM0IDUgNjIgNDJ0MjggMTEydjhxMCA1Ny0zNSA3OS0yMiAxNC00NyAxNC0zMiAwLTU5LTExdC0zOC0yM2wtMTEtMTJoM3EzLTEgOC0ydDEwLTUgMTItNyAxMC0xMSA4LTE1IDMtMjBxMC0yMi0xNC0zOXQtNDUtMTh6Ii8+PHBhdGggaWQ9Ik1KWC0xMC1URVgtTi0zNiIgZD0iTTQyIDMxM3EwIDE2MyA4MSAyNTh0MTgwIDk1cTY5IDAgOTktMzZ0MzAtODBxMC0yNS0xNC00MHQtMzktMTVxLTIzIDAtMzggMTR0LTE1IDM5cTAgNDQgNDcgNTMtMjIgMjItNjIgMjUtNzEgMC0xMTctNjAtNDctNjYtNDctMjAybDEtNHE1IDYgOCAxMyA0MSA2MCAxMDcgNjBoNHE0NiAwIDgxLTE5IDI0LTE0IDQ4LTQwdDM5LTU3cTIxLTQ5IDIxLTEwN1YxOTJxMC0yMy01LTQzLTExLTU5LTY0LTExNVQyNTMtMjJxLTI4IDAtNTQgOFQxNDMgMTYgOTIgNzUgNTYgMTcyIDQyIDMxM3ptMjE1IDg0cS0zMCAwLTUyLTE3dC0zNC00NS0xNy01Ny02LTYycTAtODMgMTItMTE5dDM4LTU4cTI0LTE4IDUzLTE4IDUxIDAgNzggMzggMTMgMTggMTggNDV0NSAxMDVxMCA4MC01IDEwN3QtMTggNDVxLTI3IDM2LTcyIDM2eiIvPjxwYXRoIGlkPSJNSlgtMTAtVEVYLU4tMzgiIGQ9Ik03MCA0MTd0MCA3NyA1NCAxMjQgMTI0IDQ4cTcxIDAgMTI2LTQydDU1LTEwOXEwLTMwLTExLTU2dC0yNi00Mi0zMS0yOC0yNi0xOC0xMS04bDE0LTlxMTQtMTAgMjgtMjB0MTYtMTFxNzUtNTkgNzUtMTQ5IDAtNzktNTgtMTM3VDI0OS0yMnEtOTAgMC0xNDggNTFUNDMgMTU1cTAgMTA4IDEyOSAxODBsLTE4IDEzcS0yMSAxMy0yNyAyMC01NyA0OS01NyAxMjZ6bTIxNi0zMSA2IDRxNiA0IDkgNnQxMCA3IDEyIDEwIDExIDEyIDExIDEzIDEwIDE2IDkgMTcgNSAyMCAyIDIycTAgNDMtMjkgNzN0LTY3IDM4cS03IDEtMzMgMS00MSAwLTc3LTI2dC0zNy02NXEwLTIzIDEzLTQydDI2LTI5IDUwLTMycTctNSAxMS03bDU4LTM4ek0yNTAgMjFxNTggMCAxZTIgMzR0NDIgODJxMCAxNy01IDMydC0xMiAyNS0yMiAyMi0yMyAxOC0yOSAxOS0yNyAxN3EtMTQgOS0zMCAxOXQtMjYgMTdsLTggNXEtNiAwLTI5LTE3dC00OC01NS0yNi04MnEwLTU5IDQzLTk3VDI1MCAyMXoiLz48cGF0aCBpZD0iTUpYLTEwLVRFWC1OLTM3IiBkPSJNNTUgNDU4cTEgMiAxNyAxMDlMODggNjc0bDIwIDJoMjB2LTRxMC0xMCAxNS0xN3Q1Mi05IDE2OS0ySDQ4NVY2MDVsLTY4LTkzcS05LTEyLTMwLTQwdC0yNy0zNy0yMS0zMi0yMC0zNi0xNC0zNy0xMy00Ni04LTU0LTYtNjgtMy04MnEwLTE0IDAtMjh0LTEtMjRWMTlxLTQtMTctMTktMjlUMjIxLTIycS0xMSAwLTIxIDNUMTc5IDAgMTY4IDQwcTAgMTU4IDk3IDMyOCAyMCAzMiA4NCAxMjFsNDYgNjNIMzAycS0xNzQgMC0xODMtNi02LTMtMTEtMjRUOTggNDc5bC0zLTIxdi0zSDU1djN6Ii8+PHBhdGggaWQ9Ik1KWC0xMC1URVgtTi0zMCIgZD0iTTk2IDU4NXE1NiA4MSAxNTMgODEgNDggMCA5Ni0yNnQ3OC05MnEzNy04MyAzNy0yMjggMC0xNTUtNDMtMjM3LTIwLTQyLTU1LTY3VDMwMS0xNXQtNTEtN3EtMjYgMC01MiA2VDEzNyAxNiA4MiA4M1EzOSAxNjUgMzkgMzIwcTAgMTc0IDU3IDI2NXptMjI1IDEycS0zMCAzMi03MSAzMi00MiAwLTcyLTMyLTI1LTI2LTMzLTcydC04LTE5MnEwLTE1OCA4LTIwOHQzNi03OXEyOC0zMCA2OS0zMCA0MCAwIDY4IDMwIDI5IDMwIDM2IDg0dDggMjAzcTAgMTQ1LTggMTkxdC0zMyA3M3oiLz48cGF0aCBpZD0iTUpYLTEwLVRFWC1OLTM5IiBkPSJNMzUyIDI4N3EtNDgtNzYtMTIwLTc2LTc4IDAtMTI4IDU5VDQ0IDM5NnEtMiAxNi0yIDQwdjhxMCA5MyA2OSAxNjIgNjAgNjAgMTMyIDYwIDIgMCA2IDB0OC0xaDRxMTIgMCAyNS0ydDM3LTEyIDQ3LTMyIDQzLTU5cTQzLTg4IDQzLTIyNiAwLTE0MC02MC0yMzctMzUtNTYtODQtODdUMjA4LTIyUTE0Ny0yMiAxMDggN1Q2OCA5M3Q1MyA1NnEyMiAwIDM3LTE0dDE1LTM5cTAtMTgtOS0zMVQxNDggNDl0LTEzLTVsLTQtMXEwLTIgNy02dDI2LTEwIDQyLTVoNnE2MCAwIDEwMSA2NCAzOSA1NiAzOSAxOTR2N3pNMjQ0IDI0OHE0OCAwIDc3IDQ5dDMwIDEzM3EwIDc4LTggMTEyLTIgMTAtNiAyMHQtMTQgMjYtMzAgMjctNDcgMTBxLTM4IDAtNjUtMjctMjEtMjItMjctNTJ0LTctMTA1cTAtODMgNS0xMTJ0MjAtNDdxMjUtMzQgNzItMzR6Ii8+PHBhdGggaWQ9Ik1KWC0xMC1URVgtTi0zMiIgZD0iTTEwOSA0MjlxLTI3IDAtNDMgMThUNTAgNDkxcTAgNzEgNTMgMTIzdDEzMiA1MnE5MSAwIDE1Mi01NnQ2Mi0xNDVxMC00My0yMC04MnQtNDgtNjgtODAtNzRxLTM2LTMxLTFlMi05MkwxNDIgOTNsNzYtMXExNTcgMCAxNjcgNSA3IDIgMjQgODl2M2g0MHYtM3EtMS0zLTEzLTkxVDQyMSAzVjBINTBWMTkgMzFxMCA3IDYgMTVUODYgODFxMjkgMzIgNTAgNTYgOSAxMCAzNCAzN3QzNCAzNyAyOSAzMyAyOCAzNCAyMyAzMCAyMSAzMiAxNSAyOSAxMyAzMiA3IDMwIDMgMzNxMCA2My0zNCAxMDl0LTk3IDQ2cS0zMyAwLTU4LTE3dC0zNS0zMy0xMC0xOWw1LTFxMTggMCAzNy0xNHQxOS00NnEwLTI1LTE2LTQydC00NS0xOHoiLz48cGF0aCBpZD0iTUpYLTEwLVRFWC1OLTI5IiBkPSJNNjAgNzQ5bDQgMXE1IDAgMTAgMEg4NmwyOC0yNHE5NC04NSAxMzctMjEydDQzLTI2NHEwLTY4LTEwLTEzMVQyNjEgMTIgMjI0LTc2dC0zOC02Ny00MS01MS0zMi0zMy0yMy0xOXEtMy0zLTQtNEg3NHEtOCAwLTExIDB0LTUgMy0zIDlxMSAxIDExIDEzUTIyMS02NCAyMjEgMjUwVDY2IDcyNXEtMTAgMTItMTEgMTMgMCA4IDUgMTF6Ii8+PHBhdGggaWQ9Ik1KWC0xMC1URVgtTi0yMjYxIiBkPSJNNTYgNDQ0cTAgMTMgMTQgMjBINzA3cTE1LTggMTUtMjAgMC0xNC0xNi0yMEg3MnEtMTYgNS0xNiAyMHptMC0yMDd0MCAxMyAxNCAyMEg3MDdxMTUtOCAxNS0yMHQtMTUtMjBINzBxLTE0IDctMTQgMjB6TTU2IDU2cTAgMTUgMTYgMjBINzA2cTE2LTYgMTYtMjAgMC0xMi0xNS0yMEg3MFE1NiA0MyA1NiA1NnoiLz48cGF0aCBpZD0iTUpYLTEwLVRFWC1OLTM0IiBkPSJNNDYyIDBRNDQ0IDMgMzMzIDMgMjE3IDMgMTk5IDBoLTlWNDZoMzFxMjAgMCAyNyAwdDE3IDIgMTQgNSA3IDhxMSAyIDEgNTR2NTBIMjh2NDZMMTc5IDQ0MlEzMzIgNjc0IDMzNCA2NzVxMiAyIDIxIDJoMThsNi02VjIxMWg5MlYxNjVIMzc5VjExNHEwLTQxIDAtNDh0Ni0xMnE4LTcgNTctOGgyOVYwaC05ek0yOTMgMjExVjU0NUw3NCAyMTJsMTA5LTFIMjkzeiIvPjwvZGVmcz48ZyBzdHJva2U9ImN1cnJlbnRjb2xvciIgZmlsbD0iY3VycmVudGNvbG9yIiBzdHJva2Utd2lkdGg9IjAiIHRyYW5zZm9ybT0ibWF0cml4KDEgMCAwIC0xIDAgMCkiPjxnIGRhdGEtbW1sLW5vZGU9Im1hdGgiPjxnIGRhdGEtbW1sLW5vZGU9Im1zdXAiPjxnIGRhdGEtbW1sLW5vZGU9Im1uIj48dXNlIHhsaW5rOmhyZWY9IiNNSlgtMTAtVEVYLU4tMzUiLz48L2c+PGcgZGF0YS1tbWwtbm9kZT0iVGVYQXRvbSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNTAwLCA0MTMpIHNjYWxlKDAuNzA3KSI+PGcgZGF0YS1tbWwtbm9kZT0ibW8iPjx1c2UgeGxpbms6aHJlZj0iI01KWC0xMC1URVgtTi0yMjEyIi8+PC9nPjxnIGRhdGEtbW1sLW5vZGU9Im1uIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSg3NzgsIDApIj48dXNlIHhsaW5rOmhyZWY9IiNNSlgtMTAtVEVYLU4tMzEiLz48L2c+PC9nPjwvZz48ZyBkYXRhLW1tbC1ub2RlPSJtc3BhY2UiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDE0NTMuNywgMCkiLz48ZyBkYXRhLW1tbC1ub2RlPSJtbyIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjQ1My43LCAwKSI+PHVzZSB4bGluazpocmVmPSIjTUpYLTEwLVRFWC1OLTI4Ii8+PC9nPjxnIGRhdGEtbW1sLW5vZGU9Im1pIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyODQyLjcsIDApIj48dXNlIHhsaW5rOmhyZWY9IiNNSlgtMTAtVEVYLU4tNkQiLz48dXNlIHhsaW5rOmhyZWY9IiNNSlgtMTAtVEVYLU4tNkYiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDgzMywgMCkiLz48dXNlIHhsaW5rOmhyZWY9IiNNSlgtMTAtVEVYLU4tNjQiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDEzMzMsIDApIi8+PC9nPjxnIGRhdGEtbW1sLW5vZGU9Im1zcGFjZSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNDg5OC4zLCAwKSIvPjxnIGRhdGEtbW1sLW5vZGU9Im1uIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSg1MjMxLjcsIDApIj48dXNlIHhsaW5rOmhyZWY9IiNNSlgtMTAtVEVYLU4tMzUiLz48dXNlIHhsaW5rOmhyZWY9IiNNSlgtMTAtVEVYLU4tMzMiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDUwMCwgMCkiLz48dXNlIHhsaW5rOmhyZWY9IiNNSlgtMTAtVEVYLU4tMzYiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDEwMDAsIDApIi8+PHVzZSB4bGluazpocmVmPSIjTUpYLTEwLVRFWC1OLTM4IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxNTAwLCAwKSIvPjx1c2UgeGxpbms6aHJlZj0iI01KWC0xMC1URVgtTi0zNyIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjAwMCwgMCkiLz48dXNlIHhsaW5rOmhyZWY9IiNNSlgtMTAtVEVYLU4tMzAiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDI1MDAsIDApIi8+PHVzZSB4bGluazpocmVmPSIjTUpYLTEwLVRFWC1OLTM5IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgzMDAwLCAwKSIvPjx1c2UgeGxpbms6aHJlZj0iI01KWC0xMC1URVgtTi0zMSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMzUwMCwgMCkiLz48dXNlIHhsaW5rOmhyZWY9IiNNSlgtMTAtVEVYLU4tMzIiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDQwMDAsIDApIi8+PC9nPjxnIGRhdGEtbW1sLW5vZGU9Im1vIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSg5NzMxLjcsIDApIj48dXNlIHhsaW5rOmhyZWY9IiNNSlgtMTAtVEVYLU4tMjkiLz48L2c+PGcgZGF0YS1tbWwtbm9kZT0ibW8iIHRyYW5zZm9ybT0idHJhbnNsYXRlKDEwMzk4LjUsIDApIj48dXNlIHhsaW5rOmhyZWY9IiNNSlgtMTAtVEVYLU4tMjI2MSIvPjwvZz48ZyBkYXRhLW1tbC1ub2RlPSJtbiIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTE0NTQuMiwgMCkiPjx1c2UgeGxpbms6aHJlZj0iI01KWC0xMC1URVgtTi0zMiIvPjx1c2UgeGxpbms6aHJlZj0iI01KWC0xMC1URVgtTi0zMSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNTAwLCAwKSIvPjx1c2UgeGxpbms6aHJlZj0iI01KWC0xMC1URVgtTi0zNCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTAwMCwgMCkiLz48dXNlIHhsaW5rOmhyZWY9IiNNSlgtMTAtVEVYLU4tMzciIHRyYW5zZm9ybT0idHJhbnNsYXRlKDE1MDAsIDApIi8+PHVzZSB4bGluazpocmVmPSIjTUpYLTEwLVRFWC1OLTM0IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyMDAwLCAwKSIvPjx1c2UgeGxpbms6aHJlZj0iI01KWC0xMC1URVgtTi0zOCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjUwMCwgMCkiLz48dXNlIHhsaW5rOmhyZWY9IiNNSlgtMTAtVEVYLU4tMzMiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDMwMDAsIDApIi8+PHVzZSB4bGluazpocmVmPSIjTUpYLTEwLVRFWC1OLTM2IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgzNTAwLCAwKSIvPjx1c2UgeGxpbms6aHJlZj0iI01KWC0xMC1URVgtTi0zNSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNDAwMCwgMCkiLz48L2c+PC9nPjwvZz48L3N2Zz4="><p>To get the other solutions, we need to keep adding the modulus value
(<em>536870912</em>) to the result and reduce when needed. The referer is located at
<em>0x2e48</em> to the LEFT of the cookie array. Since we cannot go backwards, we would
like to add <em>0xffffd1b8</em> to overflow 32 bit number and end up at the desired
address.</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=o>&gt;&gt;&gt;</span> <span class=k>def</span> <span class=nf>calc</span><span class=p>(</span><span class=n>a</span><span class=p>):</span> <span class=k>return</span> <span class=p>((</span><span class=n>a</span><span class=o>/</span><span class=mi>8</span><span class=p>)</span><span class=o>*</span><span class=mi>214748365</span><span class=p>)</span> <span class=o>%</span> <span class=p>(</span><span class=mi>1</span><span class=o>&lt;&lt;</span><span class=mi>32</span><span class=p>)</span>
<span class=o>&gt;&gt;&gt;</span> <span class=nb>sorted</span><span class=p>([(</span><span class=n>calc</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=s1>&#39;0xffffd1b8&#39;</span><span class=p>,</span><span class=mi>16</span><span class=p>))</span><span class=o>+</span><span class=n>i</span><span class=o>*</span><span class=mi>536870912</span><span class=p>)</span><span class=o>%</span><span class=p>(</span><span class=mi>1</span><span class=o>&lt;&lt;</span><span class=mi>32</span><span class=p>)</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>8</span><span class=p>)])</span>
<span class=p>[</span><span class=mi>322122251</span><span class=p>,</span> <span class=mi>858993163</span><span class=p>,</span> <span class=mi>1395864075</span><span class=p>,</span> <span class=mi>1932734987</span><span class=p>,</span> <span class=mi>2469605899</span><span class=p>,</span> <span class=mi>3006476811</span><span class=p>,</span> <span class=mi>3543347723</span><span class=p>,</span> <span class=mi>4080218635</span><span class=p>]</span>

<span class=c1># -- Let&#39;s do a check. </span>

<span class=o>&gt;&gt;&gt;</span> <span class=nb>hex</span><span class=p>((</span><span class=mi>322122251</span><span class=o>*</span><span class=mi>40</span><span class=p>)</span> <span class=o>%</span> <span class=p>(</span><span class=mi>1</span><span class=o>&lt;&lt;</span><span class=mi>32</span><span class=p>))</span>
<span class=s1>&#39;0xffffd1b8&#39;</span>
</code></pre></div><p>Now let&rsquo;s try it on my router!</p><pre><code>
send: 'GET / HTTP/1.1\r\nHost: 192.168.1.1:7547\r\nCookie: C322122251=/referer-test.html;\r\n\r\n'
reply: 'HTTP/1.1 404 Not Found\r\n'
header: Content-Type: text/html
header: Transfer-Encoding: chunked
header: Server: RomPager/4.07 UPnP/1.0
header: EXT:
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Object Not Found&lt;/title&gt;&lt;/head&gt;&lt;body&gt;
&lt;h1&gt;Object Not Found&lt;/h1&gt;The requested URL '/' was not found on the RomPager server.
&lt;p&gt;Return to &lt;A HREF=&quot;/referer-test.html&quot;&gt;last page&lt;/A&gt;&lt;p&gt;
&lt;/body&gt;&lt;/html&gt;        ^^^^^^^^^^^^^^^^^^

</code></pre><h3 id=is-there-another-way>Is there another way?</h3><p>It&rsquo;s not necessary to find a general solution, sometimes thinking differently can work too.</p><img class=centerimg src=data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNjAuNjQiIGhlaWdodD0iMTkuNjE2IiB2aWV3Qm94PSIwIC04MzMuOSA4ODc1LjQgMTA4My45IiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+PGRlZnM+PHBhdGggaWQ9Ik1KWC01NC1URVgtTi0zNCIgZD0iTTQ2MiAwUTQ0NCAzIDMzMyAzIDIxNyAzIDE5OSAwaC05VjQ2aDMxcTIwIDAgMjcgMHQxNyAyIDE0IDUgNyA4cTEgMiAxIDU0djUwSDI4djQ2TDE3OSA0NDJRMzMyIDY3NCAzMzQgNjc1cTIgMiAyMSAyaDE4bDYtNlYyMTFoOTJWMTY1SDM3OVYxMTRxMC00MSAwLTQ4dDYtMTJxOC03IDU3LThoMjlWMGgtOXpNMjkzIDIxMVY1NDVMNzQgMjEybDEwOS0xSDI5M3oiLz48cGF0aCBpZD0iTUpYLTU0LVRFWC1OLTMwIiBkPSJNOTYgNTg1cTU2IDgxIDE1MyA4MSA0OCAwIDk2LTI2dDc4LTkycTM3LTgzIDM3LTIyOCAwLTE1NS00My0yMzctMjAtNDItNTUtNjdUMzAxLTE1dC01MS03cS0yNiAwLTUyIDZUMTM3IDE2IDgyIDgzUTM5IDE2NSAzOSAzMjBxMCAxNzQgNTcgMjY1em0yMjUgMTJxLTMwIDMyLTcxIDMyLTQyIDAtNzItMzItMjUtMjYtMzMtNzJ0LTgtMTkycTAtMTU4IDgtMjA4dDM2LTc5cTI4LTMwIDY5LTMwIDQwIDAgNjggMzAgMjkgMzAgMzYgODR0OCAyMDNxMCAxNDUtOCAxOTF0LTMzIDczeiIvPjxwYXRoIGlkPSJNSlgtNTQtVEVYLU4tMjJDNSIgZD0iTTc4IDI1MHEwIDI0IDE3IDQydDQzIDE4cTI0IDAgNDItMTZ0MTktNDNxMC0yNS0xNy00M3QtNDMtMTgtNDMgMTctMTggNDN6Ii8+PHBhdGggaWQ9Ik1KWC01NC1URVgtSS03OCIgZD0iTTUyIDI4OXE3IDQyIDU0IDk3dDExNiA1NnEzNSAwIDY0LTE4dDQzLTQ1cTQyIDYzIDEwMSA2MyAzNyAwIDY0LTIydDI4LTU5cTAtMjktMTQtNDd0LTI3LTIyLTIzLTRxLTE5IDAtMzEgMTF0LTEyIDI5cTAgNDYgNTAgNjMtMTEgMTMtNDAgMTMtMTMgMC0xOS0yLTM4LTE2LTU2LTY2LTYwLTIyMS02MC0yNTggMC0yOCAxNi00MHQzNS0xMnEzNyAwIDczIDMzdDQ5IDgxcTMgMTAgNiAxMXQxNiAyaDRsMTUtOHEwLTEtMi0xMS0xNi01Ny02Mi0xMDFUMzMzLTExcS03MCAwLTEwNiA2My00MS02Mi05NC02MmgtNlE3OC0xMCA1NyAxNlQzNSA3MXEwIDMyIDE5IDUydDQ1IDIwbDQzLTQycTAtMjAtMTItMzVUMTA3IDQ2IDk0IDQxbC0zLTFxMC0xIDYtNHQxNi03IDE5LTNxMzYgMCA2MiA0NSA5IDE2IDIzIDY4dDI4IDEwOCAxNiA2NnE1IDI3IDUgMzkgMCAyOC0xNSA0MHQtMzQgMTJxLTQwIDAtNzUtMzJUOTMgMjkwcS0yLTktNS0xMHQtMTYtMkg1OHEtNiA2LTYgMTF6Ii8+PHBhdGggaWQ9Ik1KWC01NC1URVgtTi0yMjYxIiBkPSJNNTYgNDQ0cTAgMTMgMTQgMjBINzA3cTE1LTggMTUtMjAgMC0xNC0xNi0yMEg3MnEtMTYgNS0xNiAyMHptMC0yMDd0MCAxMyAxNCAyMEg3MDdxMTUtOCAxNS0yMHQtMTUtMjBINzBxLTE0IDctMTQgMjB6TTU2IDU2cTAgMTUgMTYgMjBINzA2cTE2LTYgMTYtMjAgMC0xMi0xNS0yMEg3MFE1NiA0MyA1NiA1NnoiLz48cGF0aCBpZD0iTUpYLTU0LVRFWC1JLTc5IiBkPSJNMjEgMjg3cTAgMTQgMTUgNDh0NDggNzEgNzQgMzZxNDEgMCA2Ni0yM3QyNi02NHEtMi0xOS0zLTIxIDAtMy0xNi00NnQtMzMtOTctMTYtODZxMC00MyAxNC02MHQ0Mi0xOHEyMyAwIDQzIDExdDMxIDIzIDI3IDMzcTAgMSA1IDIwdDE0IDU5IDE5IDc0cTM4IDE1MCA0MiAxNTcgMTMgMjcgNDMgMjcgMTMgMCAyMS03dDExLTEyIDItOXEwLTEzLTQ5LTIxMFQzOTEtMjNxLTI4LTgzLTk3LTEzMlQxNTYtMjA1cS00NSAwLTc5IDIyVDQzLTExN3EwIDIyIDcgMzdUNjktNTggODktNDh0MTcgM2w0NC00MnEwLTIwLTEyLTM1dC0yMy0yMC0xMy01bC0zLTFxMi01IDE5LTEydDM0LTdoOHExNyAwIDI2IDIgMzMgOSA2MSAzOHQ0MyA2MlQzMTMtOXQ4IDMwbC02LTRxLTYtNC0xOS0xMVQyNzAtNnEtMjAtNS0zOS01LTQ2IDAtODEgMjJUMTA0IDgycS0xIDctMSAzMSAwIDU3IDM1IDE0OXQzNSAxMTdxMCAxIDAgMiAwIDkgMCAxMnQtNCA3LTExIDRoLTRxLTIzIDAtNDItMTlUODIgMzQ0IDY1IDMwMnQtOC0yMi0xNi0ySDI3cS02IDYtNiA5eiIvPjxwYXRoIGlkPSJNSlgtNTQtVEVYLU4tMjgiIGQ9Ik05NCAyNTBxMCA2OSAxMCAxMzF0MjMgMTA3IDM3IDg4IDM4IDY3IDQyIDUyIDMzIDM0IDI1IDIxaDEzIDRsMTQtOXEwLTMtMTctMjF0LTQxLTUzLTQ5LTg2LTQyLTEzOC0xNy0xOTNUMTg0IDU4IDIyNS04MXQ0OS04NiA0Mi01MyAxNy0yMWwtMTUtOWgtMy0xM2wtMjggMjRRMTgwLTE0MSAxMzctMTRUOTQgMjUweiIvPjxwYXRoIGlkPSJNSlgtNTQtVEVYLU4tNkQiIGQ9Ik00MSA0Nkg1NXEzOSAwIDQ3IDE0djhxMCA5IDAgMjN0MCAzMSAxIDM5IDAgNDJxMCAzMSAwIDY2dC0xIDU5djIzcS0zIDE5LTE0IDI1dC00NSA5SDI1djIzbDIgMjMgMTAgMXExMCAxIDI4IDJ0MzcgMnExNyAxIDM2IDJ0MjkgMyAxMSAxaDNWNDAybDEtMzh0NSA1IDEyIDE1IDE5IDE4IDI5IDE5IDM4IDE2cTIwIDUgNTEgNSAxNSAwIDI4LTJ0MjMtNiAxOS04IDE1LTkgMTEtMTEgOS0xMSA3LTExIDQtMTAgMy04bDItNSAzIDRxMyA0IDYgOHQ5IDExIDEzIDEzIDE1IDEzIDIwIDEyIDIzIDEwIDI2IDcgMzEgM3ExMjYgMCAxMzctMTEzIDEtNyAxLTEzOVYxMDRxMC0zOCAyLTQ1dDExLTEwcTIxLTMgNDktM2gxNlYwaC04TDc4OCAxcS0yNCAxLTUxIDFUNjk5IDNRNTk2IDMgNTg3IDBoLThWNDZoMTZsNjEgMTZxMSAyIDEgMTM4LTEgMTM1LTIgMTQzLTYgMjgtMjAgNDJ0LTI0IDE3LTI2IDJxLTQ1IDAtNzktMzQtMjctMjctMzQtNTV0LTgtODNWMTY4IDEwOHEwLTMwIDEtNDB0My0xMyA5LTZxMjEtMyA0OS0zaDE2VjBoLThMNTEwIDFxLTIzIDEtNTAgMVQ0MjIgM1EzMTkgMyAzMTAgMGgtOFY0NmgxNmw2MSAxNnExIDIgMSAxMzgtMSAxMzUtMiAxNDMtNiAyOC0yMCA0MnQtMjQgMTctMjYgMnEtNDUgMC03OS0zNC0yNy0yNy0zNC01NXQtOC04M1YxNjggMTA4cTAtMzAgMS00MHQzLTEzIDktNnEyMS0zIDQ5LTNoMTZWMGgtOEwyMzQgMXEtMjQgMS01MSAxVDE0NSAzUTQyIDMgMzMgMEgyNVY0Nkg0MXoiLz48cGF0aCBpZD0iTUpYLTU0LVRFWC1OLTZGIiBkPSJNMjggMjE0cTAgOTUgNjUgMTY0dDE1NyA3MHE5MCAwIDE1NS02OHQ2Ni0xNjVxMC05NS02NC0xNjBUMjUwLTEwUTE1My0xMCA5MSA1N1QyOCAyMTR6TTI1MCAzMCAzNzIgMTkzdjMyIDI1cTAgMjItMSAzOHQtNyAzOC0xNiAzNi0zMSAyOC00OSAyMHEtNSAxLTE2IDEtMzAgMC01Ny0xMi00My0yMi01Ni02MXQtMTMtOTJWMjI2cTAtOTYgMTktMTM1IDMyLTYxIDEwNS02MXoiLz48cGF0aCBpZD0iTUpYLTU0LVRFWC1OLTY0IiBkPSJNMzc2IDQ5NXEwIDE2IDAgNDB0MSAzM3EwIDQ1LTEwIDU2dC01MSAxM0gyOTh2MjNsMiAyMyAxMCAxcTEwIDEgMjkgMnQzNyAycTE3IDEgMzcgMnQzMCAzIDExIDFoM1YzOTBxMC0zMDYgMS0zMDkgMy0yMCAxNC0yNnQ0NS05aDE4VjBxLTIgMC03Ni01dC03OS02aC03VjQ0bC04LTdRMzA3LTExIDIzNS0xMSAxNTgtMTEgOTYgNTBUMzQgMjE1cTAgMWUyIDYzIDE2M3QxNDcgNjRxNzUgMCAxMzItNDlWNDk1em0tMy0xNTNxLTQ1IDYzLTExMyA2My00OSAwLTg3LTM2LTI3LTI4LTM0LTY0dC04LTk0cTAtNTYgNy05MXQzNS02MXEzMC0zMyA3OC0zMyA3MSAwIDEyMiA3N1YzNDJ6Ii8+PHBhdGggaWQ9Ik1KWC01NC1URVgtTi0zMiIgZD0iTTEwOSA0MjlxLTI3IDAtNDMgMThUNTAgNDkxcTAgNzEgNTMgMTIzdDEzMiA1MnE5MSAwIDE1Mi01NnQ2Mi0xNDVxMC00My0yMC04MnQtNDgtNjgtODAtNzRxLTM2LTMxLTFlMi05MkwxNDIgOTNsNzYtMXExNTcgMCAxNjcgNSA3IDIgMjQgODl2M2g0MHYtM3EtMS0zLTEzLTkxVDQyMSAzVjBINTBWMTkgMzFxMCA3IDYgMTVUODYgODFxMjkgMzIgNTAgNTYgOSAxMCAzNCAzN3QzNCAzNyAyOSAzMyAyOCAzNCAyMyAzMCAyMSAzMiAxNSAyOSAxMyAzMiA3IDMwIDMgMzNxMCA2My0zNCAxMDl0LTk3IDQ2cS0zMyAwLTU4LTE3dC0zNS0zMy0xMC0xOWw1LTFxMTggMCAzNy0xNHQxOS00NnEwLTI1LTE2LTQydC00NS0xOHoiLz48cGF0aCBpZD0iTUpYLTU0LVRFWC1OLTMzIiBkPSJNMTI3IDQ2M3EtMjcgMC00MiAxN1Q2OSA1MjRxMCA1NSA0OCA5OHQxMTYgNDNxMzUgMCA0NC0xIDc0LTEyIDExMy01M3Q0MC04OXEwLTUyLTM0LTEwMXQtOTQtNzFsLTMtMnEwLTEgOS0zdDI5LTkgMzgtMjFxODItNTMgODItMTQwIDAtNzktNjItMTM4VDIzOC0yMnEtODAgMC0xMzggNDNUNDIgMTMwcTAgMjggMTggNDV0NDUgMThxMjggMCA0Ni0xOHQxOC00NXEwLTExLTMtMjB0LTctMTYtMTEtMTItMTItOC0xMC00LTgtM2wtNC0xcTUxLTQ1IDEyNC00NSA1NSAwIDgzIDUzIDE3IDMzIDE3IDEwMXYyMHEwIDk1LTY0IDEyNy0xNSA2LTYxIDdsLTQyIDEtMyAycS0yIDMtMiAxNmw4IDE4cTI4IDAgNTggNSAzNCA1IDYyIDQydDI4IDExMnY4cTAgNTctMzUgNzktMjIgMTQtNDcgMTQtMzIgMC01OS0xMXQtMzgtMjNsLTExLTEyaDNxMy0xIDgtMnQxMC01IDEyLTcgMTAtMTEgOC0xNSAzLTIwcTAtMjItMTQtMzl0LTQ1LTE4eiIvPjxwYXRoIGlkPSJNSlgtNTQtVEVYLU4tMjkiIGQ9Ik02MCA3NDlsNCAxcTUgMCAxMCAwSDg2bDI4LTI0cTk0LTg1IDEzNy0yMTJ0NDMtMjY0cTAtNjgtMTAtMTMxVDI2MSAxMiAyMjQtNzZ0LTM4LTY3LTQxLTUxLTMyLTMzLTIzLTE5cS0zLTMtNC00SDc0cS04IDAtMTEgMHQtNSAzLTMgOXExIDEgMTEgMTNRMjIxLTY0IDIyMSAyNTBUNjYgNzI1cS0xMCAxMi0xMSAxMyAwIDggNSAxMXoiLz48L2RlZnM+PGcgc3Ryb2tlPSJjdXJyZW50Y29sb3IiIGZpbGw9ImN1cnJlbnRjb2xvciIgc3Ryb2tlLXdpZHRoPSIwIiB0cmFuc2Zvcm09Im1hdHJpeCgxIDAgMCAtMSAwIDApIj48ZyBkYXRhLW1tbC1ub2RlPSJtYXRoIj48ZyBkYXRhLW1tbC1ub2RlPSJtbiI+PHVzZSB4bGluazpocmVmPSIjTUpYLTU0LVRFWC1OLTM0Ii8+PHVzZSB4bGluazpocmVmPSIjTUpYLTU0LVRFWC1OLTMwIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSg1MDAsIDApIi8+PC9nPjxnIGRhdGEtbW1sLW5vZGU9Im1vIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMjIyLjIsIDApIj48dXNlIHhsaW5rOmhyZWY9IiNNSlgtNTQtVEVYLU4tMjJDNSIvPjwvZz48ZyBkYXRhLW1tbC1ub2RlPSJtaSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTcyMi40LCAwKSI+PHVzZSB4bGluazpocmVmPSIjTUpYLTU0LVRFWC1JLTc4Ii8+PC9nPjxnIGRhdGEtbW1sLW5vZGU9Im1vIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyNTcyLjIsIDApIj48dXNlIHhsaW5rOmhyZWY9IiNNSlgtNTQtVEVYLU4tMjI2MSIvPjwvZz48ZyBkYXRhLW1tbC1ub2RlPSJtaSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMzYyOCwgMCkiPjx1c2UgeGxpbms6aHJlZj0iI01KWC01NC1URVgtSS03OSIvPjwvZz48ZyBkYXRhLW1tbC1ub2RlPSJtc3R5bGUiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDQxMTgsIDApIj48ZyBkYXRhLW1tbC1ub2RlPSJtc3BhY2UiLz48L2c+PGcgZGF0YS1tbWwtbm9kZT0ibW8iIHRyYW5zZm9ybT0idHJhbnNsYXRlKDQzOTUuOCwgMCkiPjx1c2UgeGxpbms6aHJlZj0iI01KWC01NC1URVgtTi0yOCIvPjwvZz48ZyBkYXRhLW1tbC1ub2RlPSJtbyIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNDc4NC44LCAwKSI+PHVzZSB4bGluazpocmVmPSIjTUpYLTU0LVRFWC1OLTZEIi8+PHVzZSB4bGluazpocmVmPSIjTUpYLTU0LVRFWC1OLTZGIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSg4MzMsIDApIi8+PHVzZSB4bGluazpocmVmPSIjTUpYLTU0LVRFWC1OLTY0IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMzMzLCAwKSIvPjwvZz48ZyBkYXRhLW1tbC1ub2RlPSJtc3R5bGUiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDY5NTEuNiwgMCkiPjxnIGRhdGEtbW1sLW5vZGU9Im1zcGFjZSIvPjwvZz48ZyBkYXRhLW1tbC1ub2RlPSJtc3VwIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSg3MjI5LjMsIDApIj48ZyBkYXRhLW1tbC1ub2RlPSJtbiI+PHVzZSB4bGluazpocmVmPSIjTUpYLTU0LVRFWC1OLTMyIi8+PC9nPjxnIGRhdGEtbW1sLW5vZGU9IlRlWEF0b20iIHRyYW5zZm9ybT0idHJhbnNsYXRlKDUwMCwgMzYzKSBzY2FsZSgwLjcwNykiPjxnIGRhdGEtbW1sLW5vZGU9Im1uIj48dXNlIHhsaW5rOmhyZWY9IiNNSlgtNTQtVEVYLU4tMzMiLz48dXNlIHhsaW5rOmhyZWY9IiNNSlgtNTQtVEVYLU4tMzIiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDUwMCwgMCkiLz48L2c+PC9nPjwvZz48ZyBkYXRhLW1tbC1ub2RlPSJtbyIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoODQ4Ni40LCAwKSI+PHVzZSB4bGluazpocmVmPSIjTUpYLTU0LVRFWC1OLTI5Ii8+PC9nPjwvZz48L2c+PC9zdmc+><p>How many additional bits can multiplying by 40 add to a number&rsquo;s binary
representation? It&rsquo;s between 32 (that&rsquo;s
<img src=/img/d851672c7ed2542e2950e6444c9c1d7a.svg alt>) and 64 (that&rsquo;s
<img src=/img/3eec1d4b188ea063f48ce9d3eac2dc3d.svg alt>), so we have to assume 6
bits. The question becomes, which number multiplied by 40 and with 6
most significant bits discarded is equal to our input variable <em>y</em>?
The router CPU might be stuck with 32 bits, but Python isn&rsquo;t. Why not
simply reconstruct these discarded bits by testing each case? Guess
what the discarded value might have been and divide by 40 to check if
the assumption was correct. For just 6 bits added, it isn&rsquo;t terribly
inefficient to check all possibilities and it goes to prove there are
many ways to address a problem. Pun intended! :)</p><pre><code>  Start with 4294955448 in binary form.
          11111111111111111101000110111000

  Multiplying by 40 gives 171798217920. In binary, that's
  100111  11111111111110001100010011000000
 overflow
</code></pre><p>The 100111 is simply too much to store in a 32 bit memory unit so it gets
discarded, and the rest we called <em>y</em>. We now need to do this in reverse,
starting from <em>y</em>, guessing the discarded part and checking if division by
40 gives the starting value. If it does - that&rsquo;s it.</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=n>t</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=s1>&#39;0xffffd1b8&#39;</span><span class=p>,</span> <span class=mi>16</span><span class=p>)</span>

<span class=o>&gt;&gt;&gt;</span> <span class=p>[</span><span class=n>i</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>map</span><span class=p>(</span><span class=k>lambda</span> <span class=n>a</span><span class=p>:</span> <span class=p>((</span><span class=n>a</span><span class=o>&lt;&lt;</span><span class=mi>32</span><span class=p>)</span><span class=o>+</span><span class=n>t</span><span class=p>)</span><span class=o>/</span><span class=mi>40</span><span class=p>,</span> <span class=nb>range</span><span class=p>(</span><span class=mi>64</span><span class=p>))</span> <span class=k>if</span> <span class=p>(</span><span class=n>i</span><span class=o>*</span><span class=mi>40</span><span class=p>)</span><span class=o>%</span><span class=p>(</span><span class=mi>1</span><span class=o>&lt;&lt;</span><span class=mi>32</span><span class=p>)</span><span class=o>==</span><span class=n>t</span> <span class=ow>and</span> <span class=n>i</span><span class=o>&lt;</span><span class=p>(</span><span class=mi>1</span><span class=o>&lt;&lt;</span><span class=mi>32</span><span class=p>)]</span>
<span class=p>[</span><span class=mi>322122251</span><span class=p>,</span> <span class=mi>858993163</span><span class=p>,</span> <span class=mi>1395864075</span><span class=p>,</span> <span class=mi>1932734987</span><span class=p>,</span> <span class=mi>2469605899</span><span class=p>,</span> <span class=mi>3006476811</span><span class=p>,</span> <span class=mi>3543347723</span><span class=p>,</span> <span class=mi>4080218635</span><span class=p>]</span>

</code></pre></div><p>So the next time you complain learning math is silly when studying for a CS
degree, just remember you might actually need it!</p></div></section><h1 class=content-subhead>05 Oct 2014, 17:25</h1><section class=post><header class=post-header><a href=https://blog.hrvoje.org/2014/10/tic-tac-toe-in-...-mysql/ class=post-title>Tic-Tac-Toe in ... MySQL</a><p class=post-meta></p></header><div class=post-description><p>If you ever attended a boring lecture, you probably know this game by heart. Frequently scribbled on textbook margins and school desks, it&rsquo;s insanely popular and fun to play. Talking to a friend about MySQL made me wonder if such a respectable, high performance database can be misused and tricked into being a gaming platfom. While it isn&rsquo;t likely going to run Quake, maybe a simple game of Tic-Tac-Toe would be just right.</p><p>Why would anyone do this? Well, making <a href="https://www.youtube.com/watch?v=qWkUFxItWmU">floppy drives play The Imperial March</a> isn’t very useful either, but it’s darn entertaining. MySQL is a powerful tool with strong scripting capabilities and Turing complete as well, so implementing this game in a single player mode is possible.</p><h3 id=implementation>Implementation</h3><p>First, we need a board. To keep things simple, we’ll keep it as a 9 letter string - matrix element with position (1,1) will be the first element, then element (1,2) and so on .</p><div class=highlight><pre class=chroma><code class=language-mysql data-lang=mysql><span class=kt>SET</span> <span class=o>@</span><span class=n>ploca</span> <span class=o>=</span> <span class=s1>&#39;_________&#39;</span><span class=p>;</span>
</code></pre></div><p>After defining something to store and describe the board in, we declare AI is using &lsquo;o&rsquo; and the player will be playing with &lsquo;x&rsquo;. Underscores are used to represent unclaimed fields. Since MySQL isn&rsquo;t Perl or Python, we&rsquo;ll have to improvise a little and create a function to check what&rsquo;s placed on the board at a specific (row,column) position.</p><div class=highlight><pre class=chroma><code class=language-mysql data-lang=mysql><span class=k>CREATE</span> <span class=n>FUNCTION</span> <span class=nf>get</span><span class=p>(</span><span class=n>instring</span> <span class=kt>VARCHAR</span><span class=p>(</span><span class=mi>255</span><span class=p>),</span> <span class=n>y</span> <span class=kt>INT</span><span class=p>,</span> <span class=n>x</span> <span class=kt>INT</span><span class=p>)</span> <span class=n>RETURNS</span> <span class=kt>CHAR</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=k>RETURN</span> <span class=nf>SUBSTRING</span><span class=p>(</span><span class=n>instring</span><span class=p>,</span> <span class=mi>3</span><span class=o>*</span><span class=p>(</span><span class=n>y</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span><span class=o>+</span><span class=n>x</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</code></pre></div><p>Now we need to think of a way to display the board to the player. There is no simple print function and we are trying to display a string as a table, so this is what I could think of.</p><div class=highlight><pre class=chroma><code class=language-mysql data-lang=mysql><span class=n>DELIMITER</span> <span class=err>$$</span>
<span class=k>CREATE</span> <span class=k>PROCEDURE</span> <span class=nf>display_board</span><span class=p>(</span><span class=k>IN</span> <span class=n>l</span> <span class=kt>VARCHAR</span><span class=p>(</span><span class=mi>16</span><span class=p>))</span>
<span class=n>BEGIN</span>
      <span class=k>DROP</span> <span class=n>TEMPORARY</span> <span class=k>TABLE</span> <span class=k>IF</span> <span class=k>EXISTS</span> <span class=o>`</span><span class=n>tablica</span><span class=o>`</span><span class=p>;</span>
      <span class=k>CREATE</span> <span class=n>TEMPORARY</span> <span class=k>TABLE</span> <span class=o>`</span><span class=n>tablica</span><span class=o>`</span> <span class=p>(</span><span class=n>ta</span> <span class=kt>varchar</span><span class=p>(</span><span class=mi>1</span><span class=p>),</span> <span class=n>bli</span> <span class=kt>varchar</span><span class=p>(</span><span class=mi>1</span><span class=p>),</span> <span class=n>ca</span> <span class=kt>varchar</span><span class=p>(</span><span class=mi>1</span><span class=p>));</span>
      <span class=k>INSERT</span> <span class=k>INTO</span> <span class=n>tablica</span> <span class=k>VALUES</span> <span class=p>(</span><span class=nf>get</span><span class=p>(</span><span class=n>l</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>),</span> <span class=nf>get</span><span class=p>(</span><span class=n>l</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>),</span> <span class=nf>get</span><span class=p>(</span><span class=n>l</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span><span class=mi>3</span><span class=p>));</span>
      <span class=k>INSERT</span> <span class=k>INTO</span> <span class=n>tablica</span> <span class=k>VALUES</span> <span class=p>(</span><span class=nf>get</span><span class=p>(</span><span class=n>l</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span><span class=mi>1</span><span class=p>),</span> <span class=nf>get</span><span class=p>(</span><span class=n>l</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span><span class=mi>2</span><span class=p>),</span> <span class=nf>get</span><span class=p>(</span><span class=n>l</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>));</span>
      <span class=k>INSERT</span> <span class=k>INTO</span> <span class=n>tablica</span> <span class=k>VALUES</span> <span class=p>(</span><span class=nf>get</span><span class=p>(</span><span class=n>l</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span><span class=mi>1</span><span class=p>),</span> <span class=nf>get</span><span class=p>(</span><span class=n>l</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span><span class=mi>2</span><span class=p>),</span> <span class=nf>get</span><span class=p>(</span><span class=n>l</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span><span class=mi>3</span><span class=p>));</span>          
      <span class=k>SELECT</span> <span class=o>*</span> <span class=k>from</span> <span class=n>tablica</span><span class=p>;</span>
<span class=n>END</span>
<span class=err>$$</span>
</code></pre></div><p>We declare a temporary table, extract characters from our board-string and select it. This will print it (somewhat) nicely to the player.</p><pre><code>+------+------+------+
| ta   | bli  | ca   |
+------+------+------+
| o    | _    | _    |
| _    | x    | _    |
| _    | _    | _    |
+------+------+------+
3 rows in set (0.02 sec)
</code></pre><h3 id=ai---making-a-respectable-oponent>AI - making a respectable oponent</h3><p>This is a good time to talk about the AI. Taking the classic approach isn&rsquo;t something you do when coding for fun, so I decided to do something different. When doing something weird in a database engine, why not use it in your advantage? Basic combinatorics tells us each field can be either &lsquo;o&rsquo;, &lsquo;x&rsquo; or empty, and there are 9 fields so that&rsquo;s 39 = 19,683 possible board positions. Also, many positions are invalid - you can&rsquo;t have all x&rsquo;s because players take turns, you can&rsquo;t play after you&rsquo;ve lost etc. so the real number of valid board is much smaller (it&rsquo;s 5477).</p><p>Game theory teaches us Tic-Tac-Toe can never actually be won if you pick optimal moves, so we&rsquo;ll run it once to generate a tree of best computer moves given a certain position, store it permanently in the database, and use it to defeat the puny human.</p><p><img src=/img/Tic-tac-toe-game-tree.svg alt="Tic tac toe"></p><p>Each optimal move for a certain position will be stored as a table row along with its predecessor&rsquo;s id, so we can look it up and know where to move.</p><pre><code>+-------+-----------+------------+------+------+--------+
| id    | matrix    | moves_next | kraj | win  | parent |
+-------+-----------+------------+------+------+--------+
| 32041 | oxooxxo_x | x          |    1 | o    |  32040 |
+-------+-----------+------------+------+------+--------+
</code></pre><p>An example of a move stored in a database - this is a finished game which a computer (&lsquo;o&rsquo; player) won. Let&rsquo;s implement a function for making a move.</p><div class=highlight><pre class=chroma><code class=language-mysql data-lang=mysql><span class=n>DELIMITER</span> <span class=err>$$</span>
<span class=k>CREATE</span> <span class=k>PROCEDURE</span> <span class=nf>place_x</span><span class=p>(</span><span class=k>IN</span> <span class=n>y</span> <span class=kt>INT</span><span class=p>,</span> <span class=k>IN</span> <span class=n>x</span> <span class=kt>INT</span><span class=p>)</span>
<span class=n>BEGIN</span>
      <span class=k>IF</span> <span class=nf>get</span><span class=p>(</span><span class=o>@</span><span class=n>ploca</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span> <span class=o>=</span> <span class=s1>&#39;_&#39;</span> <span class=k>THEN</span>   
    <span class=k>SELECT</span> <span class=nf>concat</span><span class=p>(</span><span class=nf>substring</span><span class=p>(</span><span class=o>@</span><span class=n>ploca</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=o>*</span><span class=p>(</span><span class=n>y</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span><span class=o>+</span><span class=n>x</span><span class=o>-</span><span class=mi>1</span><span class=p>),</span> <span class=s1>&#39;x&#39;</span><span class=p>,</span> <span class=nf>substring</span><span class=p>(</span><span class=o>@</span><span class=n>ploca</span><span class=p>,</span> <span class=mi>3</span><span class=o>*</span><span class=p>(</span><span class=n>y</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span><span class=o>+</span><span class=n>x</span><span class=o>+</span><span class=mi>1</span><span class=p>))</span> <span class=k>INTO</span> <span class=o>@</span><span class=n>ploca</span><span class=p>;</span>
    <span class=k>CALL</span> <span class=nf>display_board</span><span class=p>(</span><span class=o>@</span><span class=n>ploca</span><span class=p>);</span>

        <span class=k>SELECT</span> <span class=n>id</span><span class=p>,</span><span class=n>kraj</span><span class=p>,</span><span class=n>win</span> <span class=k>FROM</span> <span class=n>tictactoe</span> <span class=k>WHERE</span> <span class=n>matrix</span><span class=o>=@</span><span class=n>ploca</span> <span class=k>AND</span> <span class=n>moves_next</span><span class=o>=</span><span class=s1>&#39;o&#39;</span> <span class=k>LIMIT</span> <span class=mi>1</span> <span class=k>INTO</span> <span class=o>@</span><span class=n>parent_id</span><span class=p>,</span> <span class=o>@</span><span class=n>kraj</span><span class=p>,</span> <span class=o>@</span><span class=n>win</span><span class=p>;</span>
        <span class=k>SELECT</span> <span class=n>matrix</span><span class=p>,</span><span class=n>kraj</span><span class=p>,</span><span class=n>win</span> <span class=k>FROM</span> <span class=n>tictactoe</span> <span class=k>WHERE</span> <span class=n>parent</span><span class=o>=@</span><span class=n>parent_id</span> <span class=k>LIMIT</span> <span class=mi>1</span> <span class=k>INTO</span> <span class=o>@</span><span class=n>ploca</span><span class=p>,</span> <span class=o>@</span><span class=n>kraj</span><span class=p>,</span> <span class=o>@</span><span class=n>win</span><span class=p>;</span>
    
    <span class=k>CALL</span> <span class=nf>display_board</span><span class=p>(</span><span class=o>@</span><span class=n>ploca</span><span class=p>);</span>
    
    <span class=k>IF</span> <span class=o>@</span><span class=n>kraj</span> <span class=o>=</span> <span class=mi>1</span> <span class=k>THEN</span>   
      <span class=k>IF</span> <span class=o>@</span><span class=n>win</span> <span class=o>=</span> <span class=s1>&#39;o&#39;</span> <span class=k>THEN</span> <span class=k>SELECT</span> <span class=s1>&#39;Izgubili ste!&#39;</span> <span class=k>AS</span> <span class=s1>&#39; &#39;</span><span class=p>;</span> <span class=k>ELSE</span>  <span class=k>SELECT</span> <span class=s1>&#39;Nerijeseno. Pokusajte ponovno!&#39;</span> <span class=k>AS</span> <span class=s1>&#39; &#39;</span><span class=p>;</span> <span class=n>END</span> <span class=k>IF</span><span class=p>;</span>
      <span class=kt>SET</span> <span class=o>@</span><span class=n>ploca</span> <span class=o>=</span> <span class=s1>&#39;_________&#39;</span><span class=p>;</span>
      <span class=k>CALL</span> <span class=nf>display_board</span><span class=p>(</span><span class=o>@</span><span class=n>ploca</span><span class=p>);</span>
    <span class=n>END</span> <span class=k>IF</span><span class=p>;</span>
      <span class=n>END</span> <span class=k>IF</span><span class=p>;</span>
<span class=n>END</span>
<span class=err>$$</span>
<span class=n>DELIMITER</span> <span class=p>;</span>
</code></pre></div><h3 id=constructing-the-optimal-move-tree>Constructing the optimal move tree</h3><p>If you ever saw Wargames, you probably remember the scene where the kid saves the world by making the computer play Tic-Tac-Toe with itself. The same thing is done here (minus saving the world part). Computer plays both sides, but when impersonating a human it checks all moves, not just the best one, because a human might make a mistake. To determine the best move, a recursive minimax algorithm is used, checking long-term consequence of a move (&lsquo;move&rsquo; function) and choosing the one with a best outcome.</p><p>This python algorithm is ran only once; it recursively traverses the moves tree and inserts nodes as database rows. Our database could also be imported from external file, effectively eliminating any external dependencies, even if they are only a one-time thing. A single database row also contains state flags to determine if the game is over or not.</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python>
<span class=c1>#!/usr/bin/python</span>
<span class=kn>import</span> <span class=nn>itertools</span><span class=o>,</span> <span class=nn>hashlib</span><span class=o>,</span> <span class=nn>MySQLdb</span>

<span class=n>ploca</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=s1>&#39;_&#39;</span> <span class=o>*</span> <span class=mi>9</span><span class=p>)</span> 
<span class=n>db</span><span class=o>=</span><span class=n>MySQLdb</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=s1>&#39;localhost&#39;</span><span class=p>,</span> <span class=s1>&#39;game&#39;</span><span class=p>,</span> <span class=s1>&#39;game&#39;</span><span class=p>,</span> <span class=s1>&#39;game&#39;</span><span class=p>)</span>
<span class=n>c</span><span class=o>=</span><span class=n>db</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>

<span class=k>def</span> <span class=nf>move</span><span class=p>(</span><span class=n>ploca</span><span class=p>,</span> <span class=n>player</span><span class=p>):</span>
    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nb>set</span><span class=p>(</span><span class=n>ploca</span><span class=p>))</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span> <span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>4</span>
    <span class=n>nextplayer</span> <span class=o>=</span> <span class=s1>&#39;x&#39;</span> <span class=k>if</span> <span class=n>player</span> <span class=ow>is</span> <span class=s1>&#39;o&#39;</span> <span class=k>else</span> <span class=s1>&#39;o&#39;</span> 
    <span class=k>if</span> <span class=n>pobjednik</span><span class=p>(</span><span class=n>ploca</span><span class=p>):</span>
        <span class=k>return</span> <span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=k>if</span> <span class=n>player</span> <span class=ow>is</span> <span class=s1>&#39;x&#39;</span> <span class=k>else</span> <span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>

    <span class=n>reslist</span> <span class=o>=</span> <span class=p>[]</span>
    <span class=n>lista</span> <span class=o>=</span> <span class=p>[]</span>

    <span class=k>if</span> <span class=n>provjeri_kraj</span><span class=p>(</span><span class=n>ploca</span><span class=p>):</span> <span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span>
    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>9</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>ploca</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;_&#39;</span><span class=p>:</span> <span class=n>lista</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>

    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>lista</span><span class=p>:</span>
        <span class=n>ploca</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>=</span><span class=n>player</span>
        <span class=n>ret</span><span class=p>,</span><span class=n>mov</span><span class=o>=</span><span class=n>move</span><span class=p>(</span><span class=n>ploca</span><span class=p>,</span> <span class=n>nextplayer</span><span class=p>)</span>
        <span class=n>reslist</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ret</span><span class=p>)</span>
        <span class=n>ploca</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>=</span><span class=s1>&#39;_&#39;</span>

    <span class=k>if</span> <span class=n>player</span> <span class=ow>is</span> <span class=s1>&#39;x&#39;</span><span class=p>:</span> <span class=k>return</span> <span class=nb>max</span><span class=p>(</span><span class=n>reslist</span><span class=p>),</span><span class=n>lista</span><span class=p>[</span><span class=n>reslist</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=nb>max</span><span class=p>(</span><span class=n>reslist</span><span class=p>))]</span>
    <span class=k>else</span><span class=p>:</span> <span class=k>return</span> <span class=nb>min</span><span class=p>(</span><span class=n>reslist</span><span class=p>),</span><span class=n>lista</span><span class=p>[</span><span class=n>reslist</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=nb>min</span><span class=p>(</span><span class=n>reslist</span><span class=p>))]</span>

<span class=k>def</span> <span class=nf>moguci_potezi</span><span class=p>(</span><span class=n>ploca</span><span class=p>):</span> <span class=k>return</span> <span class=p>[</span><span class=n>i</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=mi>9</span><span class=p>),</span> <span class=n>ploca</span><span class=p>)</span> <span class=k>if</span> <span class=n>i</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=ow>is</span> <span class=s1>&#39;_&#39;</span><span class=p>]</span>
<span class=k>def</span> <span class=nf>provjeri_kraj</span><span class=p>(</span><span class=n>ploca</span><span class=p>):</span> <span class=k>return</span> <span class=bp>True</span> <span class=k>if</span> <span class=ow>not</span> <span class=nb>len</span><span class=p>(</span><span class=n>moguci_potezi</span><span class=p>(</span><span class=n>ploca</span><span class=p>))</span> <span class=k>else</span> <span class=bp>False</span>
<span class=k>def</span> <span class=nf>igraceva_polja</span><span class=p>(</span><span class=n>igrac</span><span class=p>,</span> <span class=n>ploca</span><span class=p>):</span> <span class=k>return</span> <span class=p>[</span><span class=n>i</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=mi>9</span><span class=p>),</span> <span class=n>ploca</span><span class=p>)</span> <span class=k>if</span> <span class=n>i</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=n>igrac</span><span class=p>]</span>
<span class=k>def</span> <span class=nf>nerijeseno</span><span class=p>(</span><span class=n>ploca</span><span class=p>):</span>  <span class=k>return</span> <span class=bp>True</span> <span class=k>if</span> <span class=n>provjeri_kraj</span><span class=p>(</span><span class=n>ploca</span><span class=p>)</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>pobjednik</span><span class=p>(</span><span class=n>ploca</span><span class=p>)</span> <span class=k>else</span> <span class=bp>False</span>

<span class=k>def</span> <span class=nf>pobjednik</span><span class=p>(</span><span class=n>ploca</span><span class=p>):</span>       
    <span class=n>dobitne_mogucnosti</span> <span class=o>=</span> <span class=p>([</span><span class=mi>0</span><span class=p>,</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>],</span> <span class=p>[</span><span class=mi>3</span><span class=p>,</span><span class=mi>4</span><span class=p>,</span><span class=mi>5</span><span class=p>],</span> <span class=p>[</span><span class=mi>6</span><span class=p>,</span><span class=mi>7</span><span class=p>,</span><span class=mi>8</span><span class=p>],</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span><span class=mi>3</span><span class=p>,</span><span class=mi>6</span><span class=p>],</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span><span class=mi>4</span><span class=p>,</span><span class=mi>7</span><span class=p>],</span> <span class=p>[</span><span class=mi>2</span><span class=p>,</span><span class=mi>5</span><span class=p>,</span><span class=mi>8</span><span class=p>],</span> <span class=p>[</span><span class=mi>2</span><span class=p>,</span><span class=mi>4</span><span class=p>,</span><span class=mi>6</span><span class=p>],</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span><span class=mi>4</span><span class=p>,</span><span class=mi>8</span><span class=p>])</span>
    <span class=k>for</span> <span class=n>strana</span> <span class=ow>in</span> <span class=p>(</span><span class=s1>&#39;x&#39;</span><span class=p>,</span> <span class=s1>&#39;o&#39;</span><span class=p>):</span>
        <span class=k>if</span> <span class=p>[</span><span class=nb>len</span><span class=p>([</span><span class=n>ploca</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>j</span> <span class=k>if</span> <span class=n>ploca</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=ow>is</span> <span class=n>strana</span><span class=p>])</span> <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=n>dobitne_mogucnosti</span><span class=p>]</span><span class=o>.</span><span class=n>count</span><span class=p>(</span><span class=mi>3</span><span class=p>):</span> <span class=k>return</span> <span class=n>strana</span>
    <span class=k>return</span> <span class=bp>False</span>

<span class=k>def</span> <span class=nf>povuci_potez</span><span class=p>(</span><span class=n>ploca</span><span class=p>,</span> <span class=n>strana</span><span class=p>,</span> <span class=n>parent</span><span class=p>):</span>
    <span class=n>win</span> <span class=o>=</span> <span class=s1>&#39;NULL&#39;</span>
    <span class=n>tbl</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>ploca</span><span class=p>),</span> <span class=n>strana</span><span class=p>]</span>
    
    <span class=n>kraj</span> <span class=o>=</span> <span class=mi>1</span> <span class=k>if</span> <span class=n>nerijeseno</span><span class=p>(</span><span class=n>ploca</span><span class=p>)</span> <span class=ow>or</span> <span class=n>pobjednik</span><span class=p>(</span><span class=n>ploca</span><span class=p>)</span> <span class=k>else</span> <span class=mi>0</span>
    <span class=k>if</span> <span class=n>kraj</span><span class=p>:</span> <span class=n>win</span> <span class=o>=</span> <span class=n>pobjednik</span><span class=p>(</span><span class=n>ploca</span><span class=p>)</span> <span class=k>if</span> <span class=n>pobjednik</span><span class=p>(</span><span class=n>ploca</span><span class=p>)</span> <span class=k>else</span> <span class=s1>&#39;Tie&#39;</span>

    <span class=n>tbl</span><span class=o>.</span><span class=n>extend</span><span class=p>([</span><span class=n>win</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>kraj</span><span class=p>)])</span>
    <span class=n>c</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;INSERT INTO tictactoe (matrix, moves_next, win, kraj) VALUES (&#39;{}&#39;);&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=s2>&#34;&#39;, &#39;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>tbl</span><span class=p>)))</span>
    <span class=n>lastrowid</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>lastrowid</span>
    <span class=n>db</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>

    <span class=k>if</span> <span class=n>parent</span> <span class=ow>is</span> <span class=ow>not</span> <span class=s1>&#39;NULL&#39;</span><span class=p>:</span> <span class=n>c</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;UPDATE tictactoe SET parent=&#39;{0}&#39; WHERE id=&#39;{1}&#39;&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>parent</span><span class=p>,</span> <span class=n>lastrowid</span><span class=p>))</span>
    <span class=k>if</span> <span class=n>pobjednik</span><span class=p>(</span><span class=n>ploca</span><span class=p>)</span> <span class=ow>or</span> <span class=n>nerijeseno</span><span class=p>(</span><span class=n>ploca</span><span class=p>):</span> <span class=k>return</span>

    <span class=n>slobodna_polja</span> <span class=o>=</span> <span class=n>moguci_potezi</span><span class=p>(</span><span class=n>ploca</span><span class=p>)</span>
    <span class=k>if</span> <span class=n>strana</span> <span class=o>==</span> <span class=s1>&#39;x&#39;</span><span class=p>:</span> 
        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>slobodna_polja</span><span class=p>:</span>
            <span class=n>ploca_recursive</span><span class=o>=</span><span class=n>ploca</span><span class=p>[:]</span>
            <span class=n>ploca_recursive</span><span class=p>[</span><span class=n>i</span><span class=p>[</span><span class=mi>0</span><span class=p>]]</span> <span class=o>=</span> <span class=s1>&#39;x&#39;</span>
            <span class=n>povuci_potez</span><span class=p>(</span><span class=n>ploca_recursive</span><span class=p>,</span> <span class=s1>&#39;o&#39;</span><span class=p>,</span> <span class=n>lastrowid</span><span class=p>)</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=n>ploca</span><span class=p>[</span><span class=n>move</span><span class=p>(</span><span class=n>ploca</span><span class=p>,</span> <span class=s1>&#39;o&#39;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]]</span> <span class=o>=</span> <span class=s1>&#39;o&#39;</span>
        <span class=n>povuci_potez</span><span class=p>(</span><span class=n>ploca</span><span class=p>,</span> <span class=s1>&#39;x&#39;</span><span class=p>,</span> <span class=n>lastrowid</span><span class=p>)</span>

<span class=n>povuci_potez</span><span class=p>(</span><span class=n>ploca</span><span class=p>,</span> <span class=s1>&#39;x&#39;</span><span class=p>,</span> <span class=s1>&#39;NULL&#39;</span><span class=p>)</span>

</code></pre></div><h3 id=making-it-fancy>Making it fancy</h3><p>That&rsquo;s all nice, it works, but one more thing&mldr; can we make it 3D, just for fun? Mysql can execute shell commands, but apparently you can&rsquo;t pipe anything through shell scripts. Let&rsquo;s use a trick - very often it produces long, long tables, and to facilitate looking at the data you can set a <em>pager</em> - something it will pipe your output through, like <em>less</em> or your favorite editor. Why not using that and piping it through &mldr; figlet! One apt-get install figlet later, finding a cool looking 3d font and a little sed to strip everything not important and we&rsquo;re left with this.</p><div class=highlight><pre class=chroma><code class=language-mysql data-lang=mysql><span class=n>mysql</span><span class=o>&gt;</span> <span class=n>pager</span> <span class=n>sed</span> <span class=o>-</span><span class=n>e</span> <span class=s1>&#39;s/| ta   | bli  | ca   |//g&#39;</span> <span class=o>-</span><span class=n>e</span> <span class=s1>&#39;s/  \+/ /g&#39;</span> <span class=o>-</span><span class=n>e</span> <span class=s1>&#39;s/[+\-]//g&#39;</span> <span class=o>-</span><span class=n>e</span> <span class=s1>&#39;/^$/d&#39;</span> <span class=o>|</span> <span class=n>figlet</span> <span class=o>-</span><span class=n>f</span> <span class=s1>&#39;larry3d.flf&#39;</span>
<span class=n>mysql</span><span class=o>&gt;</span> <span class=k>call</span> <span class=nf>place_x</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>);</span>
</code></pre></div><pre><code> __                  __                  __                   __       
/\ \                /\ \                /\ \                 /\ \      
\ \ \        ___    \ \ \       __  _   \ \ \                \ \ \     
 \ \ \      / __`\   \ \ \     /\ \/'\   \ \ \                \ \ \    
  \ \ \    /\ \L\ \   \ \ \    \/&gt;  &lt;/    \ \ \                \ \ \   
   \ \ \   \ \____/    \ \ \    /\_/\_\    \ \ \                \ \ \  
    \ \ \   \/___/      \ \ \   \//\/_/     \ \ \      _______   \ \ \ 
     \ \_\               \ \_\               \ \_\    /\______\   \ \_\
      \/_/                \/_/                \/_/    \/______/    \/_/
 __                   __                  __                  __       
/\ \                 /\ \                /\ \                /\ \      
\ \ \                \ \ \        ___    \ \ \       __  _   \ \ \     
 \ \ \                \ \ \      / __`\   \ \ \     /\ \/'\   \ \ \    
  \ \ \                \ \ \    /\ \L\ \   \ \ \    \/&gt;  &lt;/    \ \ \   
   \ \ \                \ \ \   \ \____/    \ \ \    /\_/\_\    \ \ \  
    \ \ \      _______   \ \ \   \/___/      \ \ \   \//\/_/     \ \ \ 
     \ \_\    /\______\   \ \_\               \ \_\               \ \_\
      \/_/    \/______/    \/_/                \/_/                \/_/
 __                  __                  __                  __       
/\ \                /\ \                /\ \                /\ \      
\ \ \       __  _   \ \ \        ___    \ \ \       __  _   \ \ \     
 \ \ \     /\ \/'\   \ \ \      / __`\   \ \ \     /\ \/'\   \ \ \    
  \ \ \    \/&gt;  &lt;/    \ \ \    /\ \L\ \   \ \ \    \/&gt;  &lt;/    \ \ \   
   \ \ \    /\_/\_\    \ \ \   \ \____/    \ \ \    /\_/\_\    \ \ \  
    \ \ \   \//\/_/     \ \ \   \/___/      \ \ \   \//\/_/     \ \ \ 
     \ \_\               \ \_\               \ \_\               \ \_\
      \/_/                \/_/                \/_/                \/_/
</code></pre><p>Check out the video (HTML5 - webm):</p><video controls preload=auto width=100% class=html-video>
<source src=/2014/10/tic-tac-toe-in-...-mysql/tictactoe.webm type=video/webm }}><p></p></video><p>Awesome!</p></div></section><h1 class=content-subhead>27 Sep 2014, 16:37</h1><section class=post><header class=post-header><a href=https://blog.hrvoje.org/2014/09/my-friends-2048-version/ class=post-title>My friend's 2048 version</a><p class=post-meta></p></header><div class=post-description><p>Recently I tried implementing a cool game called 2048 in Python and make it as short as possible. Thinking I did a decent job, I challenged a friend to give it a go. Blown away how much shorter it turned out to be, all I can say is - kudos to Veky.</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python>
<span class=kn>import</span> <span class=nn>random</span> <span class=kn>as</span> <span class=nn>R</span><span class=o>,</span><span class=nn>tkinter</span> <span class=kn>as</span> <span class=nn>T</span>
<span class=k>def</span> <span class=nf>M</span><span class=p>(</span><span class=n>n</span><span class=p>,</span><span class=n>q</span><span class=o>=</span><span class=k>lambda</span> <span class=n>m</span><span class=p>:</span><span class=nb>list</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=nb>list</span><span class=p>,</span><span class=nb>zip</span><span class=p>(</span><span class=o>*</span><span class=n>m</span><span class=p>[::</span><span class=o>-</span><span class=mi>1</span><span class=p>]))),</span><span class=n>u</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;key&#34;</span><span class=p>:</span><span class=nb>bool</span><span class=p>,</span><span class=s2>&#34;reverse&#34;</span><span class=p>:</span><span class=mi>1</span><span class=p>}):</span>
 <span class=n>m</span><span class=o>=</span><span class=n>b</span>
 <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4</span><span class=o>-</span><span class=n>n</span><span class=p>):</span><span class=n>m</span><span class=o>=</span><span class=n>q</span><span class=p>(</span><span class=n>m</span><span class=p>)</span>
 <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>m</span><span class=p>:</span>
  <span class=n>r</span><span class=o>.</span><span class=n>sort</span><span class=p>(</span><span class=o>**</span><span class=n>u</span><span class=p>)</span>
  <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>3</span><span class=p>):</span>
   <span class=k>if</span> <span class=n>r</span><span class=p>[</span><span class=n>j</span><span class=o>+</span><span class=mi>1</span><span class=p>]</span><span class=o>==</span><span class=n>r</span><span class=p>[</span><span class=n>j</span><span class=p>]:</span><span class=n>r</span><span class=p>[</span><span class=n>j</span><span class=p>:</span><span class=n>j</span><span class=o>+</span><span class=mi>2</span><span class=p>]</span><span class=o>=</span><span class=mi>2</span><span class=o>*</span><span class=n>r</span><span class=p>[</span><span class=n>j</span><span class=p>],</span><span class=mi>0</span>
  <span class=n>r</span><span class=o>.</span><span class=n>sort</span><span class=p>(</span><span class=o>**</span><span class=n>u</span><span class=p>)</span>
 <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n</span><span class=p>):</span><span class=n>m</span><span class=o>=</span><span class=n>q</span><span class=p>(</span><span class=n>m</span><span class=p>)</span>
 <span class=k>return</span> <span class=n>m</span><span class=o>*</span><span class=p>(</span><span class=n>m</span><span class=o>!=</span><span class=n>b</span><span class=p>)</span>
<span class=k>def</span> <span class=nf>A</span><span class=p>(</span><span class=n>q</span><span class=o>=</span><span class=mi>8</span><span class=o>**</span><span class=mi>8</span><span class=o>-</span><span class=mi>1</span><span class=p>):</span>
 <span class=n>k</span><span class=p>,</span><span class=n>l</span><span class=o>=</span><span class=n>R</span><span class=o>.</span><span class=n>choice</span><span class=p>([</span><span class=nb>divmod</span><span class=p>(</span><span class=n>i</span><span class=p>,</span><span class=mi>4</span><span class=p>)</span><span class=k>for</span> <span class=n>i</span><span class=p>,</span><span class=n>j</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=nb>sum</span><span class=p>(</span><span class=n>b</span><span class=p>,[]))</span><span class=k>if</span> <span class=ow>not</span> <span class=n>j</span><span class=p>])</span>
 <span class=n>b</span><span class=p>[</span><span class=n>k</span><span class=p>][</span><span class=n>l</span><span class=p>]</span><span class=o>=</span><span class=n>R</span><span class=o>.</span><span class=n>choice</span><span class=p>((</span><span class=mi>2</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>4</span><span class=p>))</span>
 <span class=k>for</span> <span class=n>l</span><span class=p>,</span><span class=n>d</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>L</span><span class=p>,</span><span class=nb>sum</span><span class=p>(</span><span class=n>b</span><span class=p>,[])):</span><span class=n>l</span><span class=o>.</span><span class=n>config</span><span class=p>(</span><span class=n>text</span><span class=o>=</span><span class=n>d</span> <span class=ow>or</span><span class=s1>&#39;&#39;</span><span class=p>,</span><span class=n>bg</span><span class=o>=</span><span class=s1>&#39;#&#39;</span><span class=o>+</span><span class=n>format</span><span class=p>(</span><span class=n>q</span><span class=o>-</span><span class=n>d</span><span class=o>*</span><span class=mi>999</span><span class=p>,</span><span class=s2>&#34;06x&#34;</span><span class=p>))</span>
<span class=k>def</span> <span class=nf>K</span><span class=p>(</span><span class=n>e</span><span class=p>):</span>
 <span class=n>c</span><span class=o>=</span><span class=n>M</span><span class=p>(</span><span class=nb>dict</span><span class=p>(</span><span class=n>Left</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span><span class=n>Up</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span><span class=n>Right</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span><span class=n>Down</span><span class=o>=</span><span class=mi>3</span><span class=p>)[</span><span class=n>e</span><span class=o>.</span><span class=n>keysym</span><span class=p>])</span>
 <span class=k>if</span> <span class=n>c</span><span class=p>:</span><span class=n>b</span><span class=p>[:]</span><span class=o>=</span><span class=n>c</span><span class=p>;</span><span class=n>A</span><span class=p>()</span>
 <span class=nb>any</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=n>M</span><span class=p>,</span><span class=n>F</span><span class=p>))</span><span class=ow>or</span><span class=p>[</span><span class=n>x</span><span class=o>.</span><span class=n>config</span><span class=p>(</span><span class=n>bg</span><span class=o>=</span><span class=s1>&#39;red&#39;</span><span class=p>,</span><span class=n>text</span><span class=o>=</span><span class=s1>&#39;&lt;E2&gt;&lt;98&gt;&lt;B9&gt;&#39;</span><span class=p>)</span><span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>L</span><span class=p>]</span>
<span class=n>F</span><span class=o>=</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>);</span><span class=n>b</span><span class=p>,</span><span class=n>t</span><span class=o>=</span><span class=p>[</span><span class=mi>4</span><span class=o>*</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=n>F</span><span class=p>],</span><span class=n>T</span><span class=o>.</span><span class=n>Tk</span><span class=p>();</span><span class=n>t</span><span class=o>.</span><span class=n>grid</span><span class=p>()</span>
<span class=n>L</span><span class=o>=</span><span class=p>[</span><span class=n>T</span><span class=o>.</span><span class=n>Button</span><span class=p>(</span><span class=n>t</span><span class=p>,</span><span class=n>height</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span><span class=n>width</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span><span class=n>font</span><span class=o>=</span><span class=p>(</span><span class=s2>&#34;Helvetica&#34;</span><span class=p>,</span><span class=mi>24</span><span class=p>))</span><span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=mi>4</span><span class=o>*</span><span class=n>F</span><span class=p>]</span>
<span class=p>[</span><span class=n>L</span><span class=p>[</span><span class=n>i</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=n>j</span><span class=p>]</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=n>row</span><span class=o>=</span><span class=n>i</span><span class=p>,</span><span class=n>column</span><span class=o>=</span><span class=n>j</span><span class=p>)</span><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>F</span> <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=n>F</span><span class=p>]</span>
<span class=n>A</span><span class=p>();</span><span class=n>t</span><span class=o>.</span><span class=n>bind</span><span class=p>(</span><span class=s1>&#39;&lt;Key&gt;&#39;</span><span class=p>,</span><span class=n>K</span><span class=p>);</span><span class=n>t</span><span class=o>.</span><span class=n>mainloop</span><span class=p>()</span>


</code></pre></div></div></section></div><div class=post-list-pagination><div class="content pure-u-1 pure-u-md-1-4"><a href=/posts/ class="post-list-pagination-item post-list-pagination-item-prev">&lt;&lt; Previous</a></div><div class="content pure-u-1 pure-u-md-1-2"><span class="post-list-pagination-item post-list-pagination-item-current">&nbsp; Page 2 of 3 &nbsp;</span></div><div class="content pure-u-1 pure-u-md-1-4"><a href=/posts/page/3/ class="post-list-pagination-item post-list-pagination-item-next">Next >></a></div></div><div class=footer><div class="pure-menu pure-menu-horizontal pure-menu-open"><ul><li><b>Respecting privacy</b> - No tracking, ads, analytics, pop-ups or off-site content.</li></ul></div></div></div></div></div><script></script></body></html>